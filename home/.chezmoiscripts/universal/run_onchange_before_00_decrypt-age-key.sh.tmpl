{{- if .secrets.age -}}
{{- includeTemplate "universal/common-before-template-header" . -}}

{{- $encryptedKey := joinPath .host.source ".keys/key.txt.age" -}}
{{- $decryptedKey := joinPath .host.home ".config/age/key.txt" -}}

if [ ! -f "{{ $decryptedKey }}" ]; then
    echo "üîê Decrypting age key: {{ $encryptedKey }}"
    mkdir -p "{{ .host.home }}/.config/age"
    chezmoi age --decrypt --output "{{ $decryptedKey }}" "{{ $encryptedKey }}"
    chmod 600 "{{ $decryptedKey }}"
    echo "‚úÖ Wrote key to {{ $decryptedKey }} (0600)"
fi
{{- end -}}
