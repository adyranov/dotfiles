#!/usr/bin/env bash

function app_apt_repo {
  if [ ! -f /etc/apt/sources.list.d/$1.list ]; then
      curl -fsSL "$2" | gpg --dearmor | sudo tee /etc/apt/trusted.gpg.d/$1.gpg
      echo "$3" | sudo tee /etc/apt/sources.list.d/$1.list
  fi
}

app_apt_repo "git-core-ubuntu-ppa" \
"https://keyserver.ubuntu.com/pks/lookup?op=get&search=0xe1dd270288b4e6030699e45fa1715d88e1df1f24" \
"deb http://ppa.launchpad.net/git-core/ppa/ubuntu $(lsb_release -cs) main"
{{- if or .toolchains.docker .toolchains.kubernetes }}

app_apt_repo "microsoft" \
"https://packages.microsoft.com/keys/microsoft.asc" \
"deb https://packages.microsoft.com/ubuntu/$(lsb_release -rs)/prod $(lsb_release -cs) main"

app_apt_repo "kubic-libcontainers-stable" \
"https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/xUbuntu_$(lsb_release -rs)/Release.key" \
"deb https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/xUbuntu_$(lsb_release -rs)/ /"
{{- end }}
{{- if or .toolchains.kubernetes }}
app_apt_repo "helm-stable-debian" \
"https://baltocdn.com/helm/signing.asc" \
"deb https://baltocdn.com/helm/stable/debian all main"

app_apt_repo "kubernetes" \
"https://packages.cloud.google.com/apt/doc/apt-key.gpg" \
"deb https://apt.kubernetes.io kubernetes-xenial main"
{{- end }}
{{- if or .toolchains.node }}

app_apt_repo "nodesource" \
"https://deb.nodesource.com/gpgkey/nodesource.gpg.key" \
"deb https://deb.nodesource.com/node_18.x $(lsb_release -cs) main"

app_apt_repo "yarn" \
"https://dl.yarnpkg.com/debian/pubkey.gpg" \
"deb https://dl.yarnpkg.com/debian/ stable main"
{{- end }}

packages=(
{{- template "universal/packages-to-install" dict "config" . "prefix" "    " }}
)

sudo apt-get update
sudo apt-get install -y ${packages[@]}
