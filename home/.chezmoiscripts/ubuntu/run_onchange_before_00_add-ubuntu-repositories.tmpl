#!/usr/bin/env bash
set -euo pipefail

function app_apt_repo {
  local name="$1"
  local key_url="$2"
  local repo_line="$3"

  if [ ! -f "/etc/apt/sources.list.d/${name}.list" ]; then
    echo "Setting up APT repository: ${name}"
    curl -fsSL "$key_url" | gpg --dearmor | sudo tee "/etc/apt/trusted.gpg.d/${name}.gpg" >/dev/null
    echo "$repo_line" | sudo tee "/etc/apt/sources.list.d/${name}.list" >/dev/null
  else
    echo "APT repository ${name} already exists, skipping."
  fi
}

{{- with .repositories.ubuntu }}
{{- range $name, $repo := . }}
app_apt_repo "{{ $name }}" "{{ $repo.key_url }}" "{{ $repo.repo_line }}"
{{- end }}
{{- end }}
