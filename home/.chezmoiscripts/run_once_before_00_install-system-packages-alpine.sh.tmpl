#!/bin/bash

set -eufo pipefail

{{ if (eq .chezmoi.os "linux") -}}
{{ if (eq .chezmoi.osRelease.id "alpine") }}

packages=(
{{ range $package := .packages -}}
{{ if not (contains "no-apk" $package) -}}
{{ $name := $package -}}
{{ $name = regexReplaceAll " \\[.*\\]" $name "" -}}
{{ if contains "apk:" $package -}}
{{ $name = regexReplaceAll ".* \\[.*apk:([\\w_-]+).*\\]" $package "${1}" -}}
{{ end -}}
{{ $name | indent 4 }}
{{ end -}}
{{ end -}}
)

sudo apk add --update ${packages[@]}
sudo rm -rf /var/cache/apk/*

{{ end -}}
{{ end -}}
