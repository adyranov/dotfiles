{{- /* -------------------- Basic User / Environment -------------------- */ -}}
{{- $username := "adyranov" -}}
{{- $name := "" -}}
{{- $email := "" -}}
{{- $restricted := false -}}
{{- $work := false -}}
{{- $gpg := dict "sign" "" "encrypt" "" -}}
{{- $secrets := dict "age" stdinIsATTY "bitwarden" false -}}
{{- $toolchains := list "cloud" "docker" "golang" "iac" "java" "kubernetes" "node" "python" "rust" "extra" -}}

{{- $data := . -}}
{{- range $k := list "git" "gpg" "host" "toolchains" -}}
  {{- $_ := set $data $k (default (dict) (get $data $k)) -}}
{{- end -}}

{{- /* -------------------- Ephemeral / Headless Detection -------------------- */ -}}
{{- $ephemeral := false -}}
{{- if or (stat "/.dockerenv") (stat "/run/.containerenv") -}}
  {{- $ephemeral = true -}}
{{- else if (and (stat "/proc/1/cgroup") (regexMatch "(docker|lxc|podman|kubepods|containerd)" (output "cat" "/proc/1/cgroup"))) -}}
  {{- $ephemeral = true -}}
{{- else if (and (stat "/proc/1/mountinfo") (regexMatch "(overlay|containers)" (output "cat" "/proc/1/mountinfo"))) -}}
  {{- $ephemeral = true -}}
{{- end -}}
{{- if $ephemeral -}}
  {{- writeToStdout "üõ≥Ô∏è Running in container / ephemeral environment.\n" -}}
{{- end -}}

{{- /* -------------------- OS / Distro -------------------- */ -}}
{{- $distro := dict "family" .chezmoi.os "id" (get .chezmoi.osRelease "id" | default .chezmoi.os) -}}
{{- if or (eq $distro.id "arch") (eq $distro.id "archarm") -}}{{- $_ := set $distro "id" "archlinux" -}}{{- end -}}
{{- $supported := list "darwin" "ubuntu" "archlinux" -}}
{{- $isSupported := false -}}
{{- range $supported -}}{{- if eq . $distro.id -}}{{- $isSupported = true -}}{{- end -}}{{- end -}}
{{- if not $isSupported -}}
  {{- writeToStdout (printf "‚ö†Ô∏è Unsupported distro: %s\n" $distro.id) -}}
  {{- exit 1 -}}
{{- end -}}

{{- /* -------------------- Brew Path -------------------- */ -}}
{{- $brewPath := "" -}}
{{- if eq .chezmoi.os "darwin" -}}
  {{- $brewPath = "/usr/local/bin/brew" -}}
  {{- if eq .chezmoi.arch "arm64" -}}
    {{- $brewPath = "/opt/homebrew/bin/brew" -}}
  {{- end -}}
{{- else -}}
  {{- $brewPath = "/home/linuxbrew/.linuxbrew/bin/brew" -}}
{{- end -}}

{{- /* -------------------- Chassis / Host Type -------------------- */ -}}
{{- $chassisType := "desktop" -}}
{{- if $ephemeral -}}
  {{- $chassisType = "ephemeral" -}}
{{- else if eq .chezmoi.os "linux" -}}
  {{- if contains (.chezmoi.kernel.osrelease | lower) "microsoft" -}}
    {{- $chassisType = "wsl" -}}
  {{- else -}}
    {{- $chassisType = (output "hostnamectl" "--json=short" | mustFromJson).Chassis -}}
  {{- end -}}
{{- else if eq .chezmoi.os "darwin" -}}
  {{- if contains "MacBook" (output "sysctl" "-n" "hw.model") -}}{{- $chassisType = "laptop" -}}{{- end -}}
{{- else if eq .chezmoi.os "windows" -}}
  {{- $chassisType = output "powershell.exe" "-noprofile" "-command" "if (Get-WmiObject -Class win32_battery) { echo 'laptop' } else { echo 'desktop' }" -}}
{{- end -}}

{{- /* -------------------- Toolchain Defaults -------------------- */ -}}
{{- $toolchainsEnabled := dict -}}
{{- $toolchainsSelected := list -}}
{{- range $t := $toolchains -}}
  {{- $with := (or (eq (env (printf "WITH_%s" (upper $t)) | lower) "1")
                   (eq (env (printf "WITH_%s" (upper $t)) | lower) "true")) -}}

  {{- $withoutAll := (or (eq (env "WITHOUT_TOOLCHAINS" | lower) "1")
                         (eq (env "WITHOUT_TOOLCHAINS" | lower) "true")) -}}

  {{- $without := (or (eq (env (printf "WITHOUT_%s" (upper $t)) | lower) "1")
                      (eq (env (printf "WITHOUT_%s" (upper $t)) | lower) "true")) -}}

  {{- $_ := set $toolchainsEnabled $t (or $with (and (not (or $withoutAll $without)) true)) -}}
{{- end -}}

{{- /* -------------------- Interactive Prompts -------------------- */ -}}
{{- $headless := false -}}
{{- if stdinIsATTY -}}
  {{- $work = promptBoolOnce $data.host "work" "üè¢ Work Environment" $work -}}
  {{- $restricted = promptBoolOnce $data.host "restricted" "üîí Restricted Environment" $restricted -}}
  {{- $username = promptStringOnce $data.git "username" "üë§ Git Username" $username -}}

  {{- if eq $username "adyranov" -}}
    {{- $name = "Artem Dyranov" -}}
    {{- $email = "artem.dyranov@gmail.com" -}}
    {{- if not $work -}}
      {{- $_ := set $gpg "sign" "0xAE12214C66692D96" -}}
      {{- $_ := set $gpg "encrypt" "0xE770F55D35040481" -}}
      {{- $_ := set $secrets "bitwarden" true -}}
    {{- end -}}
  {{- end -}}

  {{- $name = promptStringOnce $data.git "name" "üìù Git Name" $name -}}
  {{- $email = promptStringOnce $data.git "email" "üìß Git Email" $email -}}

  {{- $toolchainIcons := dict
      "cloud"       "‚òÅÔ∏è"
      "docker"      "üê≥"
      "golang"      "üêπ"
      "iac"         "üèóÔ∏è"
      "java"        "‚òï"
      "kubernetes"  "‚ò∏Ô∏è"
      "node"        "üü¢"
      "python"      "üêç"
      "rust"        "ü¶Ä"
      "extra"       "‚ú®"
  -}}

  {{- /* Build display names */ -}}
  {{- $toolchainsDisplay := list -}}
  {{- range $t := $toolchains -}}
    {{- $toolchainsDisplay = append $toolchainsDisplay (printf "%s %s" (get $toolchainIcons $t) $t) -}}
  {{- end -}}

  {{- $toolchainsSelected = promptMultichoiceOnce
      $data
      "toolchainsSelected"
      "‚öôÔ∏è Select toolchains to enable"
      $toolchainsDisplay
  -}}

  {{- range $t := $toolchains -}}
    {{- $_ := set $toolchainsEnabled $t false -}}
  {{- end -}}
  {{- range $s := $toolchainsSelected -}}
    {{- range $t := $toolchains -}}
      {{- if eq $s (printf "%s %s" (get $toolchainIcons $t) $t) -}}
        {{- $_ := set $toolchainsEnabled $t true -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}

  {{- if and (get $toolchainsEnabled "kubernetes") (not (get $toolchainsEnabled "docker")) -}}
    {{- $_ := set $toolchainsEnabled "docker" true -}}
    {{- writeToStdout "üê≥ Enabled Docker for Kubernetes.\n" -}}
  {{- end -}}

{{- writeToStdout "üí° Tip: you can re-enter your name and email with `chezmoi init --data=false`.\n" -}}
{{- else -}}
  {{- $headless = true -}}
  {{- writeToStdout "ü§ñ Running in headless environment.\n" -}}
{{- end -}}

hooks:
  read-source-state:
    pre:
      command: /usr/bin/env
      args:
        - -S
        - bash
        - -euo
        - pipefail
        - {{ joinPath .chezmoi.sourceDir (printf ".chezmoiscripts/%s/.init.sh" $distro.id) | toToml }}

{{- if $secrets.age }}
encryption: age
age:
  command: "rage"
  identity: "{{ $.chezmoi.homeDir }}/.config/age/key.txt"
  recipient: "age16kxd4ljclq9ksnxvl2ee7a5xnj744kwyv04p04ka0n3rzxdpl5nsq52svl" # pragma: allowlist secret
{{- end }}
bitwarden:
  command: "rbw"
diff:
  pager: "delta"
status:
  exclude: ["always"]
data:
  brew:
    path: "{{ $brewPath }}"
  cache:
    secrets:
      dir: "{{ joinPath .chezmoi.cacheDir "user" .chezmoi.username "secrets" }}"
  git:
    email: "{{ $email }}"
    name: "{{ $name }}"
    username: {{ $username }}
  gpg:
    sign: "{{ $gpg.sign }}"
    encrypt: "{{ $gpg.encrypt }}"
  host:
    arch: "{{ .chezmoi.arch }}"
    distro:
      family: "{{ $distro.family }}"
      id: "{{ $distro.id }}"
    home: "{{ .chezmoi.homeDir }}"
    source: "{{ .chezmoi.sourceDir }}"
    type: "{{ $chassisType }}"
    work: {{ $work }}
    interactive: {{ stdinIsATTY }}
    restricted: {{ $restricted }}
    headless: {{ $headless }}
  secrets:
    age: {{ $secrets.age }}
    bitwarden: {{ $secrets.bitwarden }}
  toolchains:
  {{- range $t, $enabled := $toolchainsEnabled }}
    {{ $t}}: {{ $enabled }}
  {{- end }}
  toolchainsSelected:
  {{- range $i, $t := $toolchainsSelected }}
    - "{{ $t }}"
  {{- end }}
