yubikey_export_age_identity() {
    local d="${XDG_CONFIG_HOME:-$HOME/.config}/age"
    local f="${d}/identities.txt"

    mkdir -p "$d" && chmod 700 "$d"
    if [[ ! -f "$f" ]]; then
        touch "$f"
        chmod 600 "$f"
    fi

    echo "ðŸ”Œ Insert YubiKey and press Enter..."
    read -r

    local raw
    if ! raw=$(age-plugin-yubikey --identity --slot 1 2>/dev/null); then
        echo "âŒ Error reading Slot 82 (Is the YubiKey inserted?)" >&2
        return 1
    fi

    local key_string=$(echo "$raw" | grep "^AGE-PLUGIN-YUBIKEY-")

    if [[ -z "$key_string" ]]; then
        echo "âŒ No valid Age identity found in Slot 82." >&2
        return 1
    fi

    if grep -Fq "$key_string" "$f"; then
        echo "âš ï¸  Identity already exists in $f. Skipping."
    else
        # Append the full block (includes comments with Serial #)
        echo "" >> "$f"
        echo "$raw" >> "$f"
        echo "âœ… Appended identity to $f"
    fi
}
